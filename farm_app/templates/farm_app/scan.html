{% extends 'farm_app/base.html' %}

{% block title %}Scan QR - Farm Management{% endblock %}

{% block content %}
<div class="card">
    <h2>üì∑ Record Activity</h2>
    <p style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">Scan QR code or enter tree ID</p>
</div>

<div class="card">
    <!-- Primary Action: Scan Button -->
    <button type="button" class="btn btn-primary" id="scan-btn" data-action="start-scanning" style="margin-bottom: 1rem;">
        üì∑ Open Camera Scanner
    </button>
    
    <div style="text-align: center; margin: 1rem 0; color: #999; font-size: 0.9rem;">OR</div>
    
    <!-- Manual Entry -->
    <div class="form-group">
        <label for="tree-id-input">Enter Tree ID</label>
        <input type="text" id="tree-id-input" placeholder="e.g., TREE-001" autofocus>
    </div>
    
    <button type="button" class="btn" id="lookup-btn" data-action="lookup-tree">Lookup Tree</button>
    
    <!-- Camera Scanner -->
    <div id="scanner-container" style="display: none; margin-top: 1.5rem;">
        <div class="scanner-overlay">
            <video id="video" autoplay playsinline></video>
            <div class="scanner-frame"></div>
        </div>
        <canvas id="canvas" style="display: none;"></canvas>
        <div style="margin-top: 1rem;">
            <button type="button" class="btn btn-danger" data-action="stop-scanning">Stop Scanning</button>
        </div>
        <p style="text-align: center; color: #666; margin-top: 0.75rem; font-size: 0.9rem;">Point camera at QR code</p>
    </div>
    
    <!-- Tree Info -->
    <div id="tree-info" class="info-box" style="display: none;">
        <strong>‚úì Tree Found:</strong> <span id="tree-display"></span>
    </div>
    
    <!-- Activity Form -->
    <div id="activity-form" style="display: none; margin-top: 1rem;">
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">Activity Details</h3>
        
        <form id="activity-form-element">
            <div class="form-group">
                <label for="activity-type">Activity Type *</label>
                <select id="activity-type" required data-action="toggle-custom-type">
                    <option value="">Select activity type</option>
                    <option value="fertilizer">üå± Fertilizer Application</option>
                    <option value="pruning">‚úÇÔ∏è Pruning</option>
                    <option value="harvesting">üåæ Harvesting</option>
                    <option value="other">üìù Other</option>
                </select>
            </div>
            
            <div class="form-group" id="custom-type-group" style="display: none;">
                <label for="custom-type">Custom Activity Type</label>
                <input type="text" id="custom-type" placeholder="e.g., Pest Treatment, Irrigation">
            </div>
            
            <div class="form-group">
                <label for="activity-date">Date *</label>
                <input type="date" id="activity-date" required>
            </div>
            
            <div class="form-group">
                <label for="quantity">Quantity (optional)</label>
                <input type="text" id="quantity" placeholder="e.g., 5kg, 10 bags">
            </div>
            
            <div class="form-group">
                <label for="notes">Notes (optional)</label>
                <textarea id="notes" placeholder="Additional notes about this activity"></textarea>
            </div>
            
            <button type="button" class="btn btn-primary" data-action="save-activity">üíæ Save Activity</button>
        </form>
    </div>
</div>

<!-- Success Message -->
<div id="success-message" class="card success-message" style="display: none;">
    <h3 style="color: #155724; margin-bottom: 0.5rem;">‚úÖ Activity Saved!</h3>
    <p style="color: #155724; margin-bottom: 1rem;">Saved locally. Sync to server from dashboard.</p>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
        <a href="{% url 'dashboard' %}" class="btn btn-small" style="flex: 1; min-width: 120px;">üìã Dashboard</a>
        <button type="button" class="btn btn-secondary btn-small" data-action="reset-form" style="flex: 1; min-width: 120px;">‚ûï Another</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
    // Use namespace to avoid conflicts when scripts are re-executed
    if (typeof window.scanPage === 'undefined') {
        window.scanPage = {};
    }
    
    // Store variables in namespace
    window.scanPage.STORAGE_KEY = 'farm_activities_pending';
    window.scanPage.currentTreeId = null;
    window.scanPage.currentFarmName = null;
    window.scanPage.scanning = false;
    window.scanPage.stream = null;
    window.scanPage.video = null;
    window.scanPage.canvas = null;
    window.scanPage.context = null;
    
    // Set today's date as default
    const dateInput = document.getElementById('activity-date');
    if (dateInput) {
        dateInput.valueAsDate = new Date();
    }
    
    // Initialize camera elements
    function initCamera() {
        window.scanPage.video = document.getElementById('video');
        window.scanPage.canvas = document.getElementById('canvas');
        if (window.scanPage.canvas) {
            window.scanPage.context = window.scanPage.canvas.getContext('2d');
        }
    }
    
    // Start QR code scanning (simplified and more compatible)
    async function startScanning() {
        if (window.scanPage.scanning) return;
        
        // Check if camera API is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Camera not supported on this device. Please enter tree ID manually.');
            return;
        }
        
        // Check if jsQR is loaded, wait for it if needed
        if (typeof jsQR === 'undefined') {
            // Try to load jsQR if not already loading
            if (!window.jsQRLoading) {
                window.jsQRLoading = true;
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
                script.onload = () => {
                    window.jsQRLoading = false;
                    // Retry scanning after library loads
                    if (typeof startScanning === 'function') {
                        startScanning();
                    }
                };
                script.onerror = () => {
                    window.jsQRLoading = false;
                    alert('Failed to load QR scanner library. Please check your connection and refresh the page.');
                };
                document.head.appendChild(script);
                return; // Wait for script to load
            } else {
                // Already loading, wait a bit
                setTimeout(() => {
                    if (typeof jsQR !== 'undefined' && typeof startScanning === 'function') {
                        startScanning();
                    } else {
                        alert('QR scanner library is still loading. Please wait a moment and try again.');
                    }
                }, 1000);
                return;
            }
        }
        
        try {
            initCamera();
            
            if (!window.scanPage.video || !window.scanPage.canvas) {
                alert('Camera elements not found. Please refresh the page.');
                return;
            }
            
            // Hide manual entry
            const treeInputParent = document.getElementById('tree-id-input')?.parentElement;
            const lookupBtn = document.getElementById('lookup-btn');
            const scanBtn = document.getElementById('scan-btn');
            
            if (treeInputParent) treeInputParent.style.display = 'none';
            if (lookupBtn) lookupBtn.style.display = 'none';
            if (scanBtn) scanBtn.style.display = 'none';
            
            // Request camera access (simplified constraints for better compatibility)
            window.scanPage.stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'environment' // Prefer back camera
                }
            });
            
            window.scanPage.video.srcObject = window.scanPage.stream;
            window.scanPage.video.setAttribute('playsinline', 'true');
            window.scanPage.video.setAttribute('webkit-playsinline', 'true'); // iOS Safari
            
            const scannerContainer = document.getElementById('scanner-container');
            if (scannerContainer) {
                scannerContainer.style.display = 'block';
                scannerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            window.scanPage.scanning = true;
            
            // Start scanning loop
            scanQRCode();
        } catch (error) {
            console.error('Camera error:', error);
            let errorMsg = 'Unable to access camera. ';
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                errorMsg += 'Please allow camera access in your browser settings.';
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                errorMsg += 'No camera found on this device.';
            } else {
                errorMsg += 'Please check permissions or enter tree ID manually.';
            }
            alert(errorMsg);
            
            // Show manual entry again
            const treeInputParent = document.getElementById('tree-id-input')?.parentElement;
            const lookupBtn = document.getElementById('lookup-btn');
            const scanBtn = document.getElementById('scan-btn');
            if (treeInputParent) treeInputParent.style.display = 'block';
            if (lookupBtn) lookupBtn.style.display = 'block';
            if (scanBtn) scanBtn.style.display = 'block';
        }
    }
    
    // Stop scanning
    function stopScanning() {
        window.scanPage.scanning = false;
        
        if (window.scanPage.stream) {
            window.scanPage.stream.getTracks().forEach(track => track.stop());
            window.scanPage.stream = null;
        }
        
        if (window.scanPage.video) {
            window.scanPage.video.srcObject = null;
        }
        
        document.getElementById('scanner-container').style.display = 'none';
        document.getElementById('tree-id-input').parentElement.style.display = 'block';
        document.getElementById('lookup-btn').style.display = 'block';
        document.getElementById('scan-btn').style.display = 'block';
    }
    
    // QR code scanning loop (simplified and more robust)
    function scanQRCode() {
        if (!window.scanPage.scanning || !window.scanPage.video || !window.scanPage.canvas || !window.scanPage.context) {
            return;
        }
        
        try {
            if (window.scanPage.video.readyState === window.scanPage.video.HAVE_ENOUGH_DATA) {
                // Set canvas size to match video
                const video = window.scanPage.video;
                const canvas = window.scanPage.canvas;
                const context = window.scanPage.context;
                
                canvas.height = video.videoHeight || video.clientHeight;
                canvas.width = video.videoWidth || video.clientWidth;
                
                // Draw video frame to canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get image data
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                // Check if jsQR is available
                if (typeof jsQR === 'undefined') {
                    // Try to load jsQR if not available
                    if (!window.jsQRLoading) {
                        console.error('jsQR library not loaded, attempting to load...');
                        window.jsQRLoading = true;
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
                        script.onload = () => {
                            window.jsQRLoading = false;
                            // Continue scanning after library loads
                            if (window.scanPage.scanning) {
                                scanQRCode();
                            }
                        };
                        script.onerror = () => {
                            window.jsQRLoading = false;
                            console.error('Failed to load jsQR library');
                            stopScanning();
                        };
                        document.head.appendChild(script);
                    }
                    return; // Wait for library to load
                }
                
                // Detect QR code
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code && code.data) {
                    // QR code detected!
                    const treeId = code.data.trim();
                    const treeInput = document.getElementById('tree-id-input');
                    if (treeInput) {
                        treeInput.value = treeId;
                        stopScanning();
                        // Small delay to ensure UI is updated
                        setTimeout(() => {
                            if (typeof lookupTree === 'function') {
                                lookupTree();
                            }
                        }, 100);
                    }
                    return; // Stop scanning
                }
            }
        } catch (error) {
            console.error('QR scanning error:', error);
            stopScanning();
            return;
        }
        
        // Continue scanning if still active
        if (window.scanPage.scanning) {
            requestAnimationFrame(scanQRCode);
        }
    }
    
    function toggleCustomType() {
        const activityType = document.getElementById('activity-type').value;
        const customGroup = document.getElementById('custom-type-group');
        customGroup.style.display = activityType === 'other' ? 'block' : 'none';
    }
    
    async function lookupTree() {
        const treeId = document.getElementById('tree-id-input').value.trim();
        
        if (!treeId) {
            alert('Please enter a tree ID');
            return;
        }
        
        // Show loading state
        const lookupBtn = document.getElementById('lookup-btn');
        lookupBtn.disabled = true;
        lookupBtn.textContent = 'Looking up...';
        
        // Check cache first
        const cacheKey = `tree_${treeId}`;
        const cached = localStorage.getItem(cacheKey);
        
        // If offline, use cache or show error
        if (!navigator.onLine) {
            if (cached) {
                try {
                    const data = JSON.parse(cached);
                    window.scanPage.currentTreeId = data.tree_id;
                    window.scanPage.currentFarmName = data.farm_name;
                    
                    document.getElementById('tree-display').textContent = `${data.tree_id} - ${data.farm_name}`;
                    document.getElementById('tree-info').style.display = 'block';
                    document.getElementById('activity-form').style.display = 'block';
                    
                    document.getElementById('activity-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    lookupBtn.disabled = false;
                    lookupBtn.textContent = 'Lookup Tree';
                    return;
                } catch (e) {
                    console.error('Error parsing cached tree data:', e);
                }
            }
            
            // Offline and not in cache
            alert('Tree not found in cache. Please connect to internet to lookup new trees.');
            lookupBtn.disabled = false;
            lookupBtn.textContent = 'Lookup Tree';
            return;
        }
        
        // Online - try to fetch from API
        try {
            const response = await fetch(`/api/tree/${treeId}/`);
            const data = await response.json();
            
            if (data.error) {
                // If we have cache, use it even if API returns error
                if (cached) {
                    const cachedData = JSON.parse(cached);
                    currentTreeId = cachedData.tree_id;
                    currentFarmName = cachedData.farm_name;
                    
                    document.getElementById('tree-display').textContent = `${cachedData.tree_id} - ${cachedData.farm_name} (cached)`;
                    document.getElementById('tree-info').style.display = 'block';
                    document.getElementById('activity-form').style.display = 'block';
                    
                    document.getElementById('activity-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    lookupBtn.disabled = false;
                    lookupBtn.textContent = 'Lookup Tree';
                    return;
                }
                
                alert('Tree not found: ' + data.error);
                lookupBtn.disabled = false;
                lookupBtn.textContent = 'Lookup Tree';
                return;
            }
            
            // Cache the response
            localStorage.setItem(cacheKey, JSON.stringify(data));
            
            window.scanPage.currentTreeId = data.tree_id;
            window.scanPage.currentFarmName = data.farm_name;
            
            document.getElementById('tree-display').textContent = `${data.tree_id} - ${data.farm_name}`;
            document.getElementById('tree-info').style.display = 'block';
            document.getElementById('activity-form').style.display = 'block';
            
            // Scroll to form
            document.getElementById('activity-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            lookupBtn.disabled = false;
            lookupBtn.textContent = 'Lookup Tree';
        } catch (error) {
            // Network error - try cache if available
            if (cached) {
                const cachedData = JSON.parse(cached);
                currentTreeId = cachedData.tree_id;
                currentFarmName = cachedData.farm_name;
                
                document.getElementById('tree-display').textContent = `${cachedData.tree_id} - ${cachedData.farm_name} (cached)`;
                document.getElementById('tree-info').style.display = 'block';
                document.getElementById('activity-form').style.display = 'block';
                
                document.getElementById('activity-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                lookupBtn.disabled = false;
                lookupBtn.textContent = 'Lookup Tree';
            } else {
                alert('Error looking up tree. Please check your connection.');
                lookupBtn.disabled = false;
                lookupBtn.textContent = 'Lookup Tree';
            }
        }
    }
    
    // Save activity function (fully client-side, no network requests)
    // Track if save is in progress to prevent duplicate saves
    if (!window.scanPage.isSaving) {
        window.scanPage.isSaving = false;
    }
    
    function saveActivity() {
        // Prevent duplicate saves
        if (window.scanPage.isSaving) {
            console.log('Save already in progress, ignoring duplicate call');
            return;
        }
        
        const activityType = document.getElementById('activity-type')?.value;
        const customType = document.getElementById('custom-type')?.value || '';
        const date = document.getElementById('activity-date')?.value;
        const quantity = document.getElementById('quantity')?.value || '';
        const notes = document.getElementById('notes')?.value || '';
        
        if (!activityType) {
            alert('Please select an activity type');
            return;
        }
        
        if (activityType === 'other' && !customType.trim()) {
            alert('Please enter a custom activity type');
            return;
        }
        
        if (!window.scanPage.currentTreeId) {
            alert('Please lookup a tree first');
            return;
        }
        
        // Set saving flag
        window.scanPage.isSaving = true;
        
        try {
            // Create activity object with unique timestamp to prevent exact duplicates
            const activity = {
                tree_id: window.scanPage.currentTreeId,
                farm_name: window.scanPage.currentFarmName,
                activity_type: activityType,
                custom_type: activityType === 'other' ? customType : '',
                date: date,
                quantity: quantity,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage (fully client-side, no network)
            const pending = JSON.parse(localStorage.getItem(window.scanPage.STORAGE_KEY) || '[]');
            
            // Check for duplicate (same tree, type, date, and timestamp within 1 second)
            const isDuplicate = pending.some(p => 
                p.tree_id === activity.tree_id &&
                p.activity_type === activity.activity_type &&
                p.date === activity.date &&
                p.custom_type === activity.custom_type &&
                Math.abs(new Date(p.timestamp) - new Date(activity.timestamp)) < 1000
            );
            
            if (isDuplicate) {
                console.log('Duplicate activity detected, not saving');
                window.scanPage.isSaving = false;
                return;
            }
            
            pending.push(activity);
            localStorage.setItem(window.scanPage.STORAGE_KEY, JSON.stringify(pending));
            
            // Show success message
            const activityForm = document.getElementById('activity-form');
            const successMessage = document.getElementById('success-message');
            if (activityForm) activityForm.style.display = 'none';
            if (successMessage) {
                successMessage.style.display = 'block';
                successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } catch (error) {
            console.error('Error saving activity:', error);
            alert('Error saving activity. Please try again.');
        } finally {
            // Reset saving flag after a short delay to prevent rapid duplicate clicks
            setTimeout(() => {
                window.scanPage.isSaving = false;
            }, 500);
        }
    }
    
    // Toggle custom type visibility
    function toggleCustomType() {
        const activityType = document.getElementById('activity-type')?.value;
        const customGroup = document.getElementById('custom-type-group');
        if (customGroup) {
            customGroup.style.display = activityType === 'other' ? 'block' : 'none';
        }
    }
    
    // Initialize form handlers (use event delegation in base.html, but also set up here for initial load)
    function initializeFormHandlers() {
        const form = document.getElementById('activity-form-element');
        if (form) {
            // Remove existing listener if any
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Only handle submit if triggered by Enter key, not button click
            newForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Check if submit was triggered by button click (button has data-action)
                const activeElement = document.activeElement;
                if (!activeElement || activeElement.getAttribute('data-action') !== 'save-activity') {
                    // Submit was likely from Enter key, call saveActivity
                    if (typeof saveActivity === 'function') {
                        saveActivity();
                    }
                }
            });
        }
        
        const activityTypeSelect = document.getElementById('activity-type');
        if (activityTypeSelect) {
            const newSelect = activityTypeSelect.cloneNode(true);
            activityTypeSelect.parentNode.replaceChild(newSelect, activityTypeSelect);
            
            newSelect.addEventListener('change', toggleCustomType);
        }
    }
    
    function resetForm() {
        stopScanning();
        document.getElementById('tree-id-input').value = '';
        document.getElementById('tree-info').style.display = 'none';
        document.getElementById('activity-form').style.display = 'none';
        document.getElementById('success-message').style.display = 'none';
        document.getElementById('activity-form-element').reset();
        const dateInput = document.getElementById('activity-date');
        if (dateInput) dateInput.valueAsDate = new Date();
        window.scanPage.currentTreeId = null;
        window.scanPage.currentFarmName = null;
        document.getElementById('tree-id-input').focus();
    }
    
    // Clean up camera on page unload
    window.addEventListener('beforeunload', function() {
        stopScanning();
    });
    
    // Attach functions to window for global access
    window.startScanning = startScanning;
    window.stopScanning = stopScanning;
    window.lookupTree = lookupTree;
    window.resetForm = resetForm;
    window.saveActivity = saveActivity;
    window.toggleCustomType = toggleCustomType;
    
    // Initialize scan page
    function initializeScanPage() {
        // Allow Enter key to trigger lookup
        const treeInput = document.getElementById('tree-id-input');
        if (treeInput) {
            // Remove existing listeners by cloning
            const newInput = treeInput.cloneNode(true);
            treeInput.parentNode.replaceChild(newInput, treeInput);
            
            newInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (typeof lookupTree === 'function') {
                        lookupTree();
                    }
                }
            });
        }
        
        // Initialize form handlers
        initializeFormHandlers();
        
        // Re-attach functions to window (in case they were cleared)
        window.startScanning = startScanning;
        window.stopScanning = stopScanning;
        window.lookupTree = lookupTree;
        window.resetForm = resetForm;
        window.saveActivity = saveActivity;
        window.toggleCustomType = toggleCustomType;
    }
    
    // Initialize on page load
    initializeScanPage();
    
    // Re-initialize when page is loaded via client-side navigation
    window.addEventListener('pageLoaded', function(e) {
        if (e.detail.url === '/scan/') {
            initializeScanPage();
        }
    });
</script>
{% endblock %}
